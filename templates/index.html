<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indeed Job Scraper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .job-card {
            transition: all 0.3s ease;
        }
        .job-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .skill-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .loading-bar {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i class="fas fa-search text-blue-600 text-2xl mr-3"></i>
                    <h1 class="text-2xl font-bold text-gray-900">Indeed Job Scraper</h1>
                </div>
                <div class="text-sm text-gray-500" id="currentTime"></div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-lg">
                        <i class="fas fa-briefcase text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Total Jobs</p>
                        <p class="text-2xl font-semibold text-gray-900" id="totalJobs">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-lg">
                        <i class="fas fa-building text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Companies</p>
                        <p class="text-2xl font-semibold text-gray-900" id="totalCompanies">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-lg">
                        <i class="fas fa-map-marker-alt text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Locations</p>
                        <p class="text-2xl font-semibold text-gray-900" id="totalLocations">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 bg-yellow-100 rounded-lg">
                        <i class="fas fa-sync text-yellow-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">Last Updated</p>
                        <p class="text-lg font-semibold text-gray-900" id="lastUpdated">Never</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column - Scraper Controls -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Start New Scraping</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Job Title</label>
                            <input type="text" id="jobTitle" placeholder="e.g. software engineer" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                            <input type="text" id="location" placeholder="e.g. bangalore" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Number of Jobs</label>
                            <input type="number" id="numJobs" min="1" max="50" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   >
                        </div>
                        
                        <button onclick="startScraping()" id="scrapeBtn" 
                                class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200">
                            <i class="fas fa-play mr-2"></i>Start Scraping
                        </button>
                    </div>
                </div>

                <!-- Scraping Status -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Scraping Status</h2>
                    <div id="scrapingStatus" class="text-center py-8">
                        <div class="text-gray-500">
                            <i class="fas fa-check-circle text-4xl mb-3 text-green-500"></i>
                            <p>Ready to scrape</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Jobs List -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-gray-900">Job Listings</h2>
                            <div class="flex space-x-2">
                                <input type="text" id="searchInput" placeholder="Search jobs..." 
                                       class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       onkeyup="filterJobs()">
                                <button onclick="refreshJobs()" class="bg-gray-100 text-gray-700 px-3 py-1 rounded-md hover:bg-gray-200 transition duration-200">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div id="jobsContainer">
                            <div class="text-center py-8">
                                <div class="loading-bar">
                                    <i class="fas fa-spinner fa-spin text-3xl text-blue-600 mb-3"></i>
                                    <p class="text-gray-500">Loading jobs...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allJobs = [];
        
        // Update current time
        
        
        // Load jobs on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadJobs();
            checkScrapingStatus();
            setInterval(checkScrapingStatus, 3000);
        });
        
        function loadJobs() {
            fetch('/api/jobs')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allJobs = data.jobs;
                        displayJobs(allJobs);
                        updateStats(data.jobs);
                    } else {
                        showError('Failed to load jobs: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('Failed to load jobs');
                });
        }
        
        function updateStats(jobs) {
            document.getElementById('totalJobs').textContent = jobs.length;
            
            const companies = new Set(jobs.map(job => job.company).filter(Boolean));
            document.getElementById('totalCompanies').textContent = companies.size;
            
            const locations = new Set(jobs.map(job => job.location).filter(Boolean));
            document.getElementById('totalLocations').textContent = locations.size;
            
            if (jobs.length > 0) {
                const latest = jobs.reduce((latest, job) => {
                    return new Date(job.scraped_at) > new Date(latest.scraped_at) ? job : latest;
                }, jobs[0]);
                document.getElementById('lastUpdated').textContent = new Date(latest.scraped_at).toLocaleTimeString();
            }
        }
        
        function displayJobs(jobs) {
            const container = document.getElementById('jobsContainer');
            
            if (jobs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">No jobs found</p>
                        <p class="text-sm text-gray-400 mt-1">Start scraping to collect job listings</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = jobs.map(job => `
                <div class="job-card bg-white border border-gray-200 rounded-lg p-6 mb-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <h3 class="text-xl font-semibold text-gray-900 mb-1">${job.title || 'No title'}</h3>
                            <div class="flex items-center text-sm text-gray-600 mb-2">
                                <i class="fas fa-building mr-2"></i>
                                <span class="font-medium">${job.company || 'Unknown company'}</span>
                                <span class="mx-2">â€¢</span>
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                <span>${job.location || 'Unknown location'}</span>
                            </div>
                        </div>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${job.employment_type || 'Full-time'}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-clock mr-2"></i>
                            <span>${job.posted_time || 'Recently'}</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-user-tie mr-2"></i>
                            <span>${job.seniority_level || 'Not specified'}</span>
                        </div>
                        ${job.salary_range ? `
                        <div class="flex items-center">
                            <i class="fas fa-money-bill-wave mr-2"></i>
                            <span class="font-medium text-green-600">${job.salary_range}</span>
                        </div>
                        ` : ''}
                        ${job.applicant_count ? `
                        <div class="flex items-center">
                            <i class="fas fa-users mr-2"></i>
                            <span>${job.applicant_count}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    ${job.extracted_skills ? `
                    <div class="mb-4">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Skills Required:</h4>
                        <div class="flex flex-wrap gap-2">
                            ${job.extracted_skills.split(',').slice(0, 8).map(skill => `
                                <span class="skill-tag text-white px-3 py-1 rounded-full text-xs font-medium">${skill.trim()}</span>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                        <div class="text-xs text-gray-500">
                            Scraped: ${new Date(job.scraped_at).toLocaleString()}
                        </div>
                        <a href="${job.job_url}" target="_blank" 
                           class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200">
                            <i class="fas fa-external-link-alt mr-2"></i>View Original
                        </a>
                    </div>
                </div>
            `).join('');
        }
        
        function filterJobs() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (!searchTerm) {
                displayJobs(allJobs);
                return;
            }
            
            const filtered = allJobs.filter(job => 
                (job.title && job.title.toLowerCase().includes(searchTerm)) ||
                (job.company && job.company.toLowerCase().includes(searchTerm)) ||
                (job.location && job.location.toLowerCase().includes(searchTerm)) ||
                (job.description && job.description.toLowerCase().includes(searchTerm)) ||
                (job.extracted_skills && job.extracted_skills.toLowerCase().includes(searchTerm))
            );
            displayJobs(filtered);
        }
        
        function refreshJobs() {
            const btn = document.querySelector('button[onclick="refreshJobs()"]');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            loadJobs();
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-sync-alt"></i>';
            }, 1000);
        }
        
        function startScraping() {
            const jobTitle = document.getElementById('jobTitle').value;
            const location = document.getElementById('location').value;
            const numJobs = document.getElementById('numJobs').value;
            
            if (!jobTitle.trim()) {
                showError('Please enter a job title');
                return;
            }
            
            const btn = document.getElementById('scrapeBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Scraping...';
            
            fetch('/api/scrape', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    job_title: jobTitle,
                    location: location,
                    num_jobs: parseInt(numJobs)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess(data.message);
                } else {
                    showError('Error: ' + data.error);
                    resetScrapeButton();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('Error starting scraping');
                resetScrapeButton();
            });
        }
        
        function checkScrapingStatus() {
            fetch('/api/scraping/status')
                .then(response => response.json())
                .then(status => {
                    const statusDiv = document.getElementById('scrapingStatus');
                    
                    if (status.is_running) {
                        statusDiv.innerHTML = `
                            <div class="text-center">
                                <div class="loading-bar mb-3">
                                    <i class="fas fa-sync-alt fa-spin text-4xl text-blue-600"></i>
                                </div>
                                <p class="font-medium text-gray-900">${status.current_job}</p>
                                <p class="text-sm text-gray-600 mt-1">Progress: ${status.progress}/${status.total_jobs} jobs</p>
                                <div class="w-full bg-gray-200 rounded-full h-2 mt-3">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${(status.progress / status.total_jobs) * 100}%"></div>
                                </div>
                            </div>
                        `;
                    } else {
                        if (status.end_time) {
                            statusDiv.innerHTML = `
                                <div class="text-center text-green-600">
                                    <i class="fas fa-check-circle text-4xl mb-3"></i>
                                    <p class="font-medium">Scraping Completed!</p>
                                    <p class="text-sm text-gray-600 mt-1">Finished at ${new Date(status.end_time).toLocaleTimeString()}</p>
                                </div>
                            `;
                            loadJobs(); // Refresh job list
                        } else {
                            statusDiv.innerHTML = `
                                <div class="text-center text-gray-500">
                                    <i class="fas fa-check-circle text-4xl mb-3"></i>
                                    <p>Ready to scrape</p>
                                </div>
                            `;
                        }
                        resetScrapeButton();
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                });
        }
        
        function resetScrapeButton() {
            const btn = document.getElementById('scrapeBtn');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-play mr-2"></i>Start Scraping';
        }
        
        function showError(message) {
            // Simple error display - you can enhance this with toast notifications
            alert('Error: ' + message);
        }
        
        function showSuccess(message) {
            // Simple success display
            alert('Success: ' + message);
        }
    </script>
</body>
</html>